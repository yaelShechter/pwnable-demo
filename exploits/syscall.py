from pwn import *
import json
import os
import shlex

def exploit_syscall_demo(challenge_config, c_source: str, binary_name: str = "demo"):
    """
    Uploads C code to the remote host, compiles static, runs it, streams output.
    Intended for NON-privilege-escalating demos.
    """
    def log(msg):
        return f"data: {json.dumps({'type': 'log', 'message': msg})}\n\n"

    def emit(t, payload):
        return f"data: {json.dumps({'type': t, **payload})}\n\n"

    try:
        yield log("Connecting over SSH...")

        context.log_level = "error"
        s = ssh(
            host=challenge_config["ssh_host"],
            port=challenge_config["ssh_port"],
            user=challenge_config["ssh_user"],
            password=challenge_config["ssh_pass"],
        )
        yield log("✓ Connected")

        tmpdir = f"/tmp/yael_{os.getpid()}"
        s.run(f"mkdir -p {shlex.quote(tmpdir)}")
        yield log(f"Working dir: {tmpdir}")

        c_path = f"{tmpdir}/{binary_name}.c"
        bin_path = f"{tmpdir}/{binary_name}"

        yield log("Uploading C file...")
        with s.sftp.open(c_path, "w") as f:
            f.write(c_source)
        yield log("✓ Uploaded")

        yield log("Compiling (static)...")
        compile_cmd = f"cd {shlex.quote(tmpdir)} && gcc -static -O2 -o {shlex.quote(binary_name)} {shlex.quote(binary_name)}.c"
        ch = s.run(compile_cmd)
        comp_out = ch.recvall(timeout=15).decode(errors="ignore").strip()
        if comp_out:
            yield emit("stdout", {"message": comp_out})
        yield log("✓ Compiled")

        yield log("Running binary...")
        run_cmd = f"cd {shlex.quote(tmpdir)} && ./{shlex.quote(binary_name)}"
        ch = s.run(run_cmd)
        out = ch.recvall(timeout=15).decode(errors="ignore").strip()

        if out:
            yield emit("stdout", {"message": out})
        else:
            yield emit("stdout", {"message": "(no output)"})

        yield log("✓ Done")
        s.close()
        yield emit("done", {})

    except Exception as e:
        yield log(f"✗ Error: {e}")
        yield emit("error", {"message": str(e)})

c_source = r"""
#include <stdio.h>
#include <unistd.h>
#include <sys/syscall.h>

int main() {
    printf("UID=%d EUID=%d\n", getuid(), geteuid());
    // call a harmless syscall here if you want
    return 0;
}
"""
